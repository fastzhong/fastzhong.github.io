+++
title = "Kubernetes 101"
date = 2020-10-01T01:08:47+08:00
readingTime = true
categories = ["äº‘ & äº‘åŸç”Ÿ"]
tags = ["kubernetes"]
toc = false
+++

ä¼°è®¡æ˜¯ç»§ Linux åï¼Œç›®å‰å½±å“æœ€å¤§çš„å¼€æºé¡¹ç›®

<!--more-->

ğŸ’¡ å‰æå‡†å¤‡ï¼šK8s å­¦ä¹ å‰å¿…é¡»è¦å…ˆäº†è§£å®¹å™¨ï¼Œå‚è€ƒ <i class="fas fa-external-link-alt"></i>&nbsp; [Docker/å®¹å™¨ 101ï¼ˆ2020.9 æ›´æ–°ï¼‰](/posts/docker101/)

## åŠŸèƒ½æ¦‚è¿°

åŒæ ·å…ˆæ¥é“å¼€èƒƒèœï¼š

{{< youtube PziYflu8cB8 >}}

Kubernetes å®šä¹‰ä¸ºå®¹å™¨ç¼–æ’å¼•æ“ï¼ˆorchestrationï¼‰ï¼ŒKubernetes å¯¹äºå®¹å™¨ï¼Œå°±ç›¸å½“äº Linux å†…æ ¸å¯¹äºçº¿ç¨‹ï¼Œè€ƒè™‘åˆ°å®¹å™¨ä½œä¸ºäº‘åŸºç¡€è®¾æ–½ä¸Šçš„åŸºæœ¬è¿è¡Œå•ä½ï¼ŒKubernetes å°±ç±»ä¼¼äº‘ä¸Šçš„æ“ä½œç³»ç»Ÿå†…æ ¸ï¼Œå…¶ä½œç”¨åŒ…å«ï¼š

![features](/images/k8s/k8s-features.png#center)

## é›†ç¾¤æ¶æ„

![architecture](/images/k8s/k8s-architecture.png#center)

Kubernetes çš„ç»„ä»¶åˆ†æˆä¸¤ç§ï¼Œé€šå¸¸ç›¸åº”è¿è¡Œåœ¨ä¸¤ç§æœºå™¨ä¸Šï¼š`Master` æ§åˆ¶èŠ‚ç‚¹è´Ÿè´£ç®¡ç†é›†ç¾¤ï¼ŒåŒ…å« <span class="kwd">kube-apiserver</span>ï¼Œ<span class="kwd">kube-controller-manager</span>ï¼Œ<span class="kwd">kube-scheduler</span>ï¼Œ<span class="kwd">etcd</span> ç»„ä»¶ï¼›`Worker`ï¼ˆSlave Nodeï¼‰èŠ‚ç‚¹è¿è¡Œå…·ä½“çš„å®¹å™¨åº”ç”¨ï¼Œç”± <span class="kwd">Container Runtime</span>ï¼Œ<span class="kwd">kubelet</span> å’Œ <span class="kwd">kube-proxy</span> ç»„æˆã€‚

Master ä¹Ÿç§°ä¸ºæ§åˆ¶é¢æ¿ï¼ˆControl Panelï¼‰ï¼š

![master node](/images/k8s/master-node.png#center)

-   <span class="kwd">kube-apiserver</span> æä¾›äº†èµ„æºæ“ä½œçš„å”¯ä¸€å…¥å£ï¼Œå¹¶æä¾›è®¤è¯ã€æˆæƒã€è®¿é—®æ§åˆ¶ã€API æ³¨å†Œå’Œå‘ç°ç­‰æœºåˆ¶ï¼Œåªæœ‰ API Server ä¼šä¸ etcd è¿›è¡Œé€šä¿¡ï¼Œå…¶å®ƒæ¨¡å—éƒ½å¿…é¡»é€šè¿‡ API Server è®¿é—®é›†ç¾¤çŠ¶æ€ã€‚API Server å°è£…äº†æ ¸å¿ƒèµ„æºå¯¹è±¡çš„å¢åˆ æ”¹æŸ¥æ“ä½œï¼Œä»¥ RESTFul æ¥å£æ–¹å¼æä¾›ç»™å¤–éƒ¨å®¢æˆ·ç«¯å’Œå†…éƒ¨ç»„ä»¶è°ƒç”¨ï¼ŒAPI Server å†å¯¹ç›¸å…³çš„èµ„æºæ•°æ®ï¼ˆå…¨é‡æŸ¥è¯¢ + å˜åŒ–ç›‘å¬ï¼‰è¿›è¡Œæ“ä½œï¼Œä»¥è¾¾åˆ°å®æ—¶å®Œæˆç›¸å…³çš„ä¸šåŠ¡åŠŸèƒ½ã€‚

-   <span class="kwd">kube-controller-manager</span> è´Ÿè´£ç»´æŠ¤å„ç§èµ„æºå¯¹è±¡ï¼Œä»ç°åœ¨çŠ¶æ€ï¼ˆstatusï¼‰åˆ°ç”¨æˆ·æƒ³è¦çš„çŠ¶æ€ï¼ˆspecï¼‰ï¼Œæ¯”å¦‚æ•…éšœæ£€æµ‹ã€è‡ªåŠ¨æ‰©å±•ã€æ»šåŠ¨æ›´æ–°ç­‰ï¼Œå…·ä½“ç”±å„ç§ controller è´Ÿè´£æ‰§è¡Œï¼š
    ![controller](/images/k8s/k8s-controller-manager.png#center)

-   <span class="kwd">kube-scheduler</span> è´Ÿè´£èµ„æºçš„è°ƒåº¦ï¼Œä¸»è¦ç”¨äºæ”¶é›†å’Œåˆ†æå½“å‰ Kubernetes é›†ç¾¤ä¸­æ‰€æœ‰è´Ÿè½½èŠ‚ç‚¹çš„èµ„æº (åŒ…æ‹¬å†…å­˜ã€CPU ç­‰) è´Ÿè½½æƒ…å†µï¼Œå¹¶æŒ‰ç…§é¢„å®šçš„è°ƒåº¦ç­–ç•¥ï¼ˆä¾‹å¦‚ï¼šæ ¹æ®ç”¨æˆ·å¯¹èµ„æºè¦æ±‚ï¼ŒCPUã€å†…å­˜ã€æ¥è¯„ä¼°å“ªä¸ª nodes æœ€åˆé€‚è¿è¡Œï¼‰å°† Pod è°ƒåº¦åˆ°ç›¸åº”çš„æœºå™¨ä¸Šã€‚

-   <span class="kwd">etcd</span> ä¿å­˜äº†æ•´ä¸ªé›†ç¾¤/èµ„æºçš„çŠ¶æ€ï¼Œæ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼ key-value å­˜å‚¨ã€‚

Worker Nodeï¼ˆè´Ÿè½½èŠ‚ç‚¹ï¼‰æ˜¯ Kubernetes é›†ç¾¤é‡Œçš„å•å°æœåŠ¡å™¨ï¼Œæ‰§è¡Œå¹¶è¿è¡Œä» Master ä¼ æ¥çš„å„ç§è´Ÿè½½ä»»åŠ¡ï¼š

![workder node](/images/k8s/worker-node.png#center)

-   <span class="kwd">kubelet</span> ç›¸å½“äº Master çš„ agentï¼Œè´Ÿè´£å’Œ Master çš„é€šä¿¡ï¼Œç»´æŒ Pod/å®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸï¼ŒåŒæ—¶ç¡®å®šå…¶ç¬¦åˆ YAML æ‰€å®šä¹‰çš„ PodSpecï¼Œå…¶ä¸­åŒ…æ‹¬å…³äº Volumeï¼ˆCVIï¼‰å’Œç½‘ç»œï¼ˆCNIï¼‰çš„ç®¡ç†ã€‚

-   <span class="kwd">Container runtime</span> è´Ÿè´£é•œåƒç®¡ç†ä»¥åŠ Pod å’Œå®¹å™¨çš„çœŸæ­£è¿è¡Œæ—¶ï¼ˆCRIï¼‰ï¼Œé»˜è®¤çš„å®¹å™¨è¿è¡Œæ—¶ä¸º Dockerã€‚

-   <span class="kwd">kube-proxy</span> è´Ÿè´£ä¸º Service æä¾›å†…éƒ¨çš„æœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡ï¼ŒæŠŠ request è½¬å‘åˆ°ç›¸å…³å®¹å™¨ä¸Šï¼›

æ­¤å¤–è¿˜æœ‰éå¸¸é‡è¦çš„é›†ç¾¤ç®¡ç†å‘½ä»¤è¡Œå®¢æˆ·ç«¯å·¥å…·é›† `Kubectl`ï¼Œé€šè¿‡ Kubectl å‘½ä»¤å¯¹ API Server è¿›è¡Œæ“ä½œï¼ŒAPI Server å“åº”å¹¶è¿”å›å¯¹åº”çš„å‘½ä»¤ç»“æœï¼Œä»è€Œè¾¾åˆ°å¯¹ Kubernetes é›†ç¾¤çš„ç®¡ç†ã€‚

Kubernetes è¿˜æœ‰ä¸€äº›å®‰è£…æ‰©å±•ä»¥è¾¾åˆ°çœŸæ­£å¯ä½¿ç”¨ï¼ŒåŒ…æ‹¬ç½‘ç»œ Calico/Flannelï¼ŒCoreDNSï¼ŒDashboard ç­‰ï¼Œå‚è€ƒ[å®‰è£…æ‰©å±•](https://kubernetes.io/zh/docs/concepts/cluster-administration/addons/)ã€‚

## æ ¸å¿ƒèµ„æºå¯¹è±¡

å’Œ OS ç±»ä¼¼ï¼ŒKubernetes å¯¹åº•å±‚é™æ€å’Œè¿è¡Œæ—¶çš„èµ„æºéƒ½è¿›è¡Œäº†æŠ½è±¡ï¼ŒKubernetes çš„ç¼–æ’å’Œç®¡ç†åŠŸèƒ½å°±æ˜¯é€šè¿‡å¯¹è¿™äº›å¯¹è±¡è¿›è¡Œç¼–æ’å’Œç®¡ç†ï¼š

```md
-   workloadï¼šPodã€ReplicaSetã€Deploymentã€StatefulSetã€DaemonSetã€Jobã€CronJob
-   æœåŠ¡å‘ç°åŠå‡è¡¡ï¼šServiceã€Ingress
-   é…ç½®ä¸å­˜å‚¨ï¼š
    -   Volumeã€CSI
    -   ConfigMapã€Secret
    -   DownwardAPI
-   é›†ç¾¤çº§èµ„æºï¼šNamespaceã€Noneã€Roleã€ClusterRoleã€RoleBindingã€ClusterRoleBinding
-   å…ƒæ•°æ®ç±»å‹èµ„æºï¼šHPAã€PodTemplateã€LimitRange
```

åœ¨ Kubernetes ä¸­ï¼Œæ‰€æœ‰èµ„æºå¯¹è±¡çš„é…ç½®éƒ½åœ¨é…ç½®æ¸…å•ä¸­å®šä¹‰ï¼ˆyaml æˆ– jsonï¼‰ï¼ŒåŸºæœ¬æ ¼å¼ï¼š

```yaml
apiVersion:
    # ä»¥ "group/version" å½¢å¼æŒ‡æ˜ï¼Œè¿™ä¸ªå¯¹è±¡å±äºå“ªä¸ª API ç»„ï¼ˆç‰ˆæœ¬ï¼‰
kind:
    # èµ„æºç±»åˆ«ï¼Œæ ‡è®°åˆ›å»ºä»€ä¹ˆç±»å‹çš„èµ„æº: Pod, Deployment, Job ç­‰
metadata:
    # å…ƒæ•°æ®å†…éƒ¨æ˜¯åµŒå¥—çš„å­—æ®µ
    # å®šä¹‰äº†èµ„æºå¯¹è±¡çš„åç§°ã€å‘½åç©ºé—´ï¼ˆk8sçº§åˆ«çš„ä¸æ˜¯ç³»ç»Ÿçš„ï¼‰ç­‰ã€æ ‡ç­¾ã€æ³¨è§£ã€UIDç­‰
spec:
    # è§„èŒƒå®šä¹‰èµ„æºåº”è¯¥æ‹¥æœ‰ä»€ä¹ˆæ ·çš„ç‰¹æ€§ï¼Œä¾é æ§åˆ¶å™¨ç¡®ä¿ç‰¹æ€§èƒ½å¤Ÿè¢«æ»¡è¶³
    # å®ƒæ˜¯ç”¨æˆ·å®šä¹‰çš„æ‰€æœŸæœ›äº†èµ„æºçŠ¶æ€
status:
    # æ˜¾ç¤ºèµ„æºçš„å½“å‰çŠ¶æ€ï¼Œk8s å°±æ˜¯ç¡®ä¿å½“å‰çŠ¶æ€å‘ç›®æ ‡çŠ¶æ€æ— é™é è¿‘ä»è€Œæ»¡è¶³ç”¨æˆ·æœŸæœ›
    # å®ƒæ˜¯åªè¯»çš„ï¼Œä»£è¡¨äº†èµ„æºå½“å‰çŠ¶æ€
```

å‡ ä¸ªæ ¸å¿ƒèµ„æºä»‹ç»ï¼š

![æ ¸å¿ƒèµ„æº](/images/k8s/k8s-objects.png#center)

-   <span class="kwd">Pod</span>

Pod æ˜¯ä¸€ç»„ç´§å¯†å…³è”çš„å®¹å™¨é›†åˆï¼Œå®ƒä»¬å…±äº« PIDã€IPCã€Network å’Œ UTS namespaceï¼Œæ˜¯ Kubernetes è°ƒåº¦çš„åŸºæœ¬å•ä½ã€‚Pod çš„è®¾è®¡ç†å¿µæ˜¯æ”¯æŒå¤šä¸ªå®¹å™¨åœ¨ä¸€ä¸ª Pod ä¸­å…±äº«ç½‘ç»œå’Œæ–‡ä»¶ç³»ç»Ÿï¼Œå¯ä»¥é€šè¿‡è¿›ç¨‹é—´é€šä¿¡å’Œæ–‡ä»¶å…±äº«è¿™ç§ç®€å•é«˜æ•ˆçš„æ–¹å¼ç»„åˆå®ŒæˆæœåŠ¡ã€‚æˆ‘ä»¬çŸ¥é“å®¹å™¨æœ¬è´¨ä¸Šå°±æ˜¯è¿›ç¨‹ï¼Œé‚£ä¹ˆ <span class="uline">Pod å®é™…ä¸Šå°±æ˜¯è¿›ç¨‹ç»„äº†</span>ï¼Œåªæ˜¯è¿™ä¸€ç»„è¿›ç¨‹æ˜¯ä½œä¸ºä¸€ä¸ªæ•´ä½“æ¥è¿›è¡Œè°ƒåº¦çš„ã€‚

```yaml
kind: Pod
metadata:
    name: pod-deme # pod çš„åç§°
    namespace: default
    labels:
        app: myapp
        tier: frontend
spec:
    containers:
        - name: myapp # è¿è¡Œçš„å®¹å™¨åç§°
          image: ikubernetes/myapp:v1 # å®¹å™¨çš„é•œåƒ
          imagePullPolicy: IfNotPresent # ä»ä»“åº“è·å–é•œåƒçš„ç­–ç•¥
          ports: # å®šä¹‰å®¹å™¨æš´æ¼çš„ç«¯å£
        - name: busybox
          image: busybox:latest
          command:
              - "/bin/sh"
              - "-c"
              - "sleep 10"
```

-   <span class="kwd">Replica Set</span>

å£°æ˜ Pod çš„æ¨ªå‘æ°´å¹³æ‰©å±•ï¼Œselector æ ‡ç­¾é€‰æ‹©å™¨ï¼Œå¯ä»¥ä½¿ç”¨ matchLabelsã€matchExpressions ä¸¤ç§ç±»å‹çš„é€‰æ‹©å™¨æ¥é€‰ä¸­ç›®æ ‡ PODï¼š

```yaml
apiVersion: apps/v1
kind: ReplicaSet
metadata:
    name: myrs
    namespace: default
spec:
    replicas: 2
    selector:
        matchLabels:
            app: myapp
            release: canary
    template:
        metadata:
            name: myapp-pod
            labels:
                app: myapp # æ ‡ç­¾ä¸€å®šè¦ç¬¦åˆ replicaset æ ‡ç­¾é€‰æ‹©å™¨çš„è§„åˆ™
                release: canary
        spec:
            containers:
                - name: myapp-containers
                  image: ikubernetes/myapp:v1
                  ports:
                      - name: http
                        containerPort: 80
```

-   <span class="kwd">Deployment</span>

ä¸€èˆ¬ä¸ç›´æ¥ç®¡ç† Podï¼Œè€Œæ˜¯é€šè¿‡ Deployment æ¥ç®¡ç†åº”ç”¨ç¨‹åºã€‚Deployment é€šè¿‡æ§åˆ¶ ReplicaSet æ¥å®ç°åŠŸèƒ½ï¼Œé™¤äº†æ”¯æŒ ReplicaSet çš„æ‰©ç¼©å®¹æ„å¤–ï¼Œè¿˜æ”¯æŒæ»šåŠ¨æ›´æ–°å’Œå›æ»šç­‰ï¼Œè¿˜æä¾›äº†å£°æ˜å¼çš„é…ç½®ï¼Œè¿™ä¸ªæ˜¯æˆ‘ä»¬æ—¥å¸¸ä½¿ç”¨æœ€å¤šçš„æ§åˆ¶å™¨ã€‚å®ƒæ˜¯ç”¨æ¥ç®¡ç†æ— çŠ¶æ€çš„åº”ç”¨ã€‚

Deployment åœ¨æ»šåŠ¨æ›´æ–°æ—¶å€™ï¼Œé€šè¿‡æ§åˆ¶å¤šä¸ª ReplicaSet æ¥å®ç°ï¼ŒReplicaSet åˆæ§åˆ¶å¤šä¸ª PODï¼Œå¤šä¸ª ReplicaSet ç›¸å½“äºå¤šä¸ªåº”ç”¨çš„ç‰ˆæœ¬ã€‚

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
    name: myapp-deploy
    namespace: default
spec:
    replicas: 2
    selector:
        matchLabels:
            app: myapp
            release: canary
    template:
        metadata:
            labels:
                app: myapp
                release: canary
        spec:
            containers:
                - name: myapp
                  image: ikubernetes/myapp:v1
                  ports:
                      - name: http
                        containerPort: 80
```

-   <span class="kwd">Service</span>

Service ä¸º POD æ§åˆ¶å™¨æ§åˆ¶çš„ POD é›†ç¾¤æä¾›ä¸€ä¸ªå›ºå®šçš„è®¿é—®ç«¯ç‚¹ - ä¸€ä¸ªé›†ç¾¤å†…éƒ¨æœ‰æ•ˆçš„è™šæ‹Ÿ IPï¼Œé›†ç¾¤å†…éƒ¨é€šè¿‡è™šæ‹Ÿ IP è®¿é—®ä¸€ä¸ªæœåŠ¡ï¼Œè´Ÿè½½å‡è¡¡ç”± Kube-proxy å®ç°ã€‚Service çš„å·¥ä½œè¿˜ä¾èµ–äºä¸€ä¸ªå®‰è£…æ‰©å±•ï¼Œå°±æ˜¯ CoreDNS ï¼Œå®ƒå°† Service åœ°å€æä¾›ä¸€ä¸ªåŸŸåè§£æã€‚

```yaml
apiVersion: v1
kind: Service
metadata:
    name: redis
    namespace: default
spec:
    selector:
        app: redis
        role: logstor
    type: ClusterIP
    clusterIP: 10.96.0.100
    ports:
        - port: 6379 # service ç«¯å£
          targetPort: 6379 # pod ç›‘å¬çš„ç«¯å£
          protocol: TCP
```

-   <span class="kwd">StatefulSet</span>

StatefulSet æ˜¯ä¸ºäº†è§£å†³æœ‰çŠ¶æ€æœåŠ¡çš„é—®é¢˜ï¼ˆå¯¹åº” Deployments å’Œ ReplicaSets æ˜¯ä¸ºæ— çŠ¶æ€æœåŠ¡è€Œè®¾è®¡ï¼‰ï¼Œå…¶åº”ç”¨åœºæ™¯åŒ…æ‹¬

1. ç¨³å®šçš„æŒä¹…åŒ–å­˜å‚¨ï¼Œå³ Pod é‡æ–°è°ƒåº¦åè¿˜æ˜¯èƒ½è®¿é—®åˆ°ç›¸åŒçš„æŒä¹…åŒ–æ•°æ®ï¼›
2. ç¨³å®šçš„ç½‘ç»œæ ‡å¿—ï¼Œå³ Pod é‡æ–°è°ƒåº¦åå…¶ PodName å’Œ HostName ä¸å˜ï¼›
3. æœ‰åºéƒ¨ç½²ï¼Œæœ‰åºæ‰©å±•ï¼Œå³ Pod æ˜¯æœ‰é¡ºåºçš„ï¼Œåœ¨éƒ¨ç½²æˆ–è€…æ‰©å±•çš„æ—¶å€™è¦ä¾æ®å®šä¹‰çš„é¡ºåºä¾æ¬¡ä¾åºè¿›è¡Œï¼ˆå³ä» 0 åˆ° N-1ï¼Œåœ¨ä¸‹ä¸€ä¸ª Pod è¿è¡Œä¹‹å‰æ‰€æœ‰ä¹‹å‰çš„ Pod å¿…é¡»éƒ½æ˜¯ Running å’Œ Ready çŠ¶æ€ï¼‰ï¼›
4. æœ‰åºæ”¶ç¼©ï¼Œæœ‰åºåˆ é™¤ï¼ˆå³ä» N-1 åˆ° 0ï¼‰ï¼›

-   <span class="kwd">Namespace</span>

Namespace æ˜¯å¯¹ä¸€ç»„èµ„æºå¯¹è±¡çš„æŠ½è±¡é›†åˆï¼Œæ¯”å¦‚å¯ä»¥ç”¨æ¥å°†ç³»ç»Ÿå†…éƒ¨çš„å¯¹è±¡åˆ’åˆ†ä¸ºä¸åŒçš„é¡¹ç›®ç»„æˆ–ç”¨æˆ·ç»„ï¼Œç”¨æ¥åŒ…æ‹¬é‰´æƒã€èµ„æºç®¡ç†ç­‰ã€‚å¸¸è§çš„ pods, services, replication controllers å’Œ deployments ç­‰éƒ½æ˜¯å±äºæŸä¸€ä¸ª namespace çš„ï¼ˆé»˜è®¤æ˜¯ defaultï¼‰ï¼Œè€Œ node, persistentVolumes ç­‰åˆ™ä¸å±äºä»»ä½• namespaceã€‚åŒä¸€ä¸ª Namespace ä¸­çš„èµ„æºå‘½åå¿…é¡»å”¯ä¸€ã€‚

Namespace å¸¸ç”¨æ¥éš”ç¦»ä¸åŒçš„å›¢é˜Ÿ/ç”¨æˆ·/é¡¹ç›®ï¼Œæ¯”å¦‚ Kubernetes è‡ªå¸¦çš„æœåŠ¡ä¸€èˆ¬è¿è¡Œåœ¨ kube-system namespace ä¸­ã€‚

-   <span class="kwd">Volume</span>

ç”¨æ¥å£°æ˜åœ¨ Pod ä¸­çš„å®¹å™¨å¯ä»¥è®¿é—®æ–‡ä»¶ç›®å½•çš„ï¼Œä¸€ä¸ªå·å¯ä»¥è¢«æŒ‚è½½åœ¨ Pod ä¸­ä¸€ä¸ªæˆ–è€…å¤šä¸ªå®¹å™¨çš„æŒ‡å®šè·¯å¾„ä¸‹é¢ã€‚

Volume å¯ä»¥å»æ”¯æŒå¤šç§çš„åç«¯çš„å­˜å‚¨ï¼Œå¯ä»¥æ”¯æŒæœ¬åœ°çš„å­˜å‚¨ï¼Œç½‘ç»œå­˜å‚¨ï¼Œä»¥åŠåˆ†å¸ƒå¼çš„å­˜å‚¨ï¼Œæ¯”å¦‚è¯´åƒ cephï¼ŒGlusterFSï¼›å®ƒä¹Ÿå¯ä»¥æ”¯æŒäº‘å­˜å‚¨ï¼Œæ¯”å¦‚è¯´é˜¿é‡Œäº‘ç›˜ã€AWS äº‘ç›˜ã€Google äº‘ç›˜ç­‰ç­‰ã€‚

```yaml
apiVersion: v1
kind: Pod
metadata:
    name: myapp
    namespace: default
    labels:
        app: myapp
spec:
    containers:
        - name: myapp
          image: ikubernetes/myapp:v1
          volumeMounts: # å®¹å™¨æŒ‚è½½å“ªäº›å·
              - name: webstore # æŒ‚è½½å“ªä¸ªå·
                mountPath: /usr/share/nginx/html # æŒ‚è½½åˆ°å®¹å™¨å†…å“ªä¸ªç›®å½•
                readOnly: false # æ˜¯å¦åªè¯»
    volumes: # å­˜å‚¨å·å±äºPODçš„ï¼ˆä¸å±äºå®¹å™¨)
        - name: webstore # å­˜å‚¨å·å¯¹è±¡åå­—
          hostPath: # hostpath ç±»å‹çš„å­˜å‚¨å·å¯¹è±¡
              path: /data/myapp # å¤„äºå®¿ä¸»æœºçš„ç›®å½•
              type: DirectoryOrCreate # ä¸å­˜åœ¨åˆ™åˆ›å»º
```

-   <span class="kwd">ConfigMap</span>

ConfigMap ç”¨äºä¿å­˜é…ç½®æ•°æ®çš„é”®å€¼å¯¹ï¼Œå¯ä»¥ç”¨æ¥ä¿å­˜å•ä¸ªå±æ€§ï¼Œä¹Ÿå¯ä»¥ç”¨æ¥ä¿å­˜é…ç½®æ–‡ä»¶ã€‚å¯ä»¥ä½¿ç”¨ kubectl create configmap ä»æ–‡ä»¶ã€ç›®å½•æˆ–è€… key-value å­—ç¬¦ä¸²åˆ›å»ºç­‰åˆ›å»º ConfigMapã€‚ä¹Ÿå¯ä»¥é€šè¿‡ kubectl create -f file åˆ›å»ºã€‚

ConfigMap å¯ä»¥é€šè¿‡ä¸‰ç§æ–¹å¼åœ¨ Pod ä¸­ä½¿ç”¨ï¼Œä¸‰ç§åˆ†åˆ«æ–¹å¼ä¸ºï¼šè®¾ç½®ç¯å¢ƒå˜é‡ã€è®¾ç½®å®¹å™¨å‘½ä»¤è¡Œå‚æ•°ä»¥åŠåœ¨ Volume ä¸­ç›´æ¥æŒ‚è½½æ–‡ä»¶æˆ–ç›®å½•ã€‚

-   <span class="kwd">Secret</span>

Secret å’Œ ConfigMap ä½œç”¨ä¸€æ ·ï¼Œä½†ç”¨äºå¯†ç ã€token ç­‰æ•æ„Ÿæ•°æ®ã€‚

-   <span class="kwd">Label</span>

Labelï¼ˆæ ‡ç­¾ï¼‰ä»¥ key/value çš„æ–¹å¼é™„åŠ åˆ°å¯¹è±¡ä¸Šï¼ˆkey æœ€é•¿ä¸èƒ½è¶…è¿‡ 63 å­—èŠ‚ï¼Œvalue å¯ä»¥ä¸ºç©ºï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸è¶…è¿‡ 253 å­—èŠ‚çš„å­—ç¬¦ä¸²ï¼‰ã€‚ Label å®šä¹‰å¥½åå…¶ä»–å¯¹è±¡å¯ä»¥ä½¿ç”¨ Selector æ¥é€‰æ‹©ä¸€ç»„ç›¸åŒ label çš„å¯¹è±¡ï¼ˆæ¯”å¦‚ ReplicaSet å’Œ Service ç”¨ label æ¥é€‰æ‹©ä¸€ç»„ Podï¼‰ã€‚Label Selector æ”¯æŒä»¥ä¸‹å‡ ç§æ–¹å¼ï¼š

    -   ç­‰å¼ï¼Œå¦‚ app=nginx å’Œ env!=production
    -   é›†åˆï¼Œå¦‚ env in (production, qa)
    -   å¤šä¸ª labelï¼ˆå®ƒä»¬ä¹‹é—´æ˜¯ AND å…³ç³»ï¼‰ï¼Œå¦‚ app=nginx,env=test

-   <span class="kwd">Annotations</span>

Annotations æ˜¯ key/value å½¢å¼é™„åŠ äºå¯¹è±¡çš„æ³¨è§£ã€‚ä¸åŒäº Labels ç”¨äºæ ‡å¿—å’Œé€‰æ‹©å¯¹è±¡ï¼ŒAnnotations åˆ™æ˜¯ç”¨æ¥è®°å½•ä¸€äº›é™„åŠ ä¿¡æ¯ï¼Œç”¨æ¥è¾…åŠ©åº”ç”¨éƒ¨ç½²ã€å®‰å…¨ç­–ç•¥ä»¥åŠè°ƒåº¦ç­–ç•¥ç­‰ã€‚æ¯”å¦‚ deployment ä½¿ç”¨ annotations æ¥è®°å½• rolling update çš„çŠ¶æ€ã€‚

## æ¶æ„åŸç†

Kubernetes è™½ç„¶åºå¤§å¤æ‚ï¼Œä½†æ˜¯å…¶æ¶æ„å’Œè®¾è®¡æœºç†å´æ˜¯å¾ˆæ¸…æ™°ã€‚

åˆ†å±‚æ¶æ„ï¼š
![åˆ†å±‚æ¶æ„](/images/k8s/k8s-layers.jpg#center)

```md
-   æ ¸å¿ƒå±‚ï¼šKubernetes æœ€æ ¸å¿ƒçš„åŠŸèƒ½ï¼Œå¯¹å¤–æä¾› API æ„å»ºé«˜å±‚çš„åº”ç”¨ï¼Œå¯¹å†…æä¾›æ’ä»¶å¼åº”ç”¨æ‰§è¡Œç¯å¢ƒ
-   åº”ç”¨å±‚ï¼šéƒ¨ç½²ï¼ˆæ— çŠ¶æ€åº”ç”¨ã€æœ‰çŠ¶æ€åº”ç”¨ã€æ‰¹å¤„ç†ä»»åŠ¡ã€é›†ç¾¤åº”ç”¨ç­‰ï¼‰å’Œè·¯ç”±ï¼ˆæœåŠ¡å‘ç°ã€DNS è§£æç­‰ï¼‰
-   ç®¡ç†å±‚ï¼šç³»ç»Ÿåº¦é‡ï¼ˆå¦‚åŸºç¡€è®¾æ–½ã€å®¹å™¨å’Œç½‘ç»œçš„åº¦é‡ï¼‰ï¼Œè‡ªåŠ¨åŒ–ï¼ˆå¦‚è‡ªåŠ¨æ‰©å±•ã€åŠ¨æ€ Provision ç­‰ï¼‰ä»¥åŠç­–ç•¥ç®¡ç†ï¼ˆRBACã€Quotaã€PSPã€NetworkPolicy ç­‰ï¼‰
-   æ¥å£å±‚ï¼škubectl å‘½ä»¤è¡Œå·¥å…·ã€å®¢æˆ·ç«¯ SDK ä»¥åŠé›†ç¾¤è”é‚¦
-   ç”Ÿæ€ç³»ç»Ÿï¼šåœ¨æ¥å£å±‚ä¹‹ä¸Šçš„åºå¤§å®¹å™¨é›†ç¾¤ç®¡ç†è°ƒåº¦çš„ç”Ÿæ€ç³»ç»Ÿï¼Œå¯ä»¥åˆ’åˆ†ä¸ºä¸¤ä¸ªèŒƒç•´
    -   Kubernetes å¤–éƒ¨ï¼šæ—¥å¿—ã€ç›‘æ§ã€é…ç½®ç®¡ç†ã€CIã€CDã€Workflowã€FaaSã€OTS åº”ç”¨ã€ChatOps ç­‰
    -   Kubernetes å†…éƒ¨ï¼šCRIã€CNIã€CVIã€é•œåƒä»“åº“ã€Cloud Providerã€é›†ç¾¤è‡ªèº«çš„é…ç½®å’Œç®¡ç†ç­‰
```

æ ¸å¿ƒç»„ä»¶ï¼š
![æ ¸å¿ƒç»„ä»¶](/images/k8s/k8s-core-components.png#center)

ç”Ÿæ€ç³»ç»Ÿï¼š
![ç”Ÿæ€ç³»ç»Ÿ](/images/k8s/k8s-ecosystem.png#center)

## Kubernetes ä»¥åŠäº‘åŸç”Ÿ

æŠ€æœ¯æ˜¯ç”Ÿäº§åŠ›å‘å±•çš„æ ¸å¿ƒï¼Œå‘ç”Ÿç¬¬äºŒæ¬¡å·¥ä¸šé©å‘½æ˜¯å› ä¸ºæœ‰äº†è’¸æ±½åŠ¨åŠ›ç­‰æŠ€æœ¯çš„å‡ºç°ï¼Œå‘ç”Ÿ Internet æ˜¯å› ä¸ºæœ‰äº† HTMLï¼ŒCSSï¼ŒTcp/Ip ç­‰æŠ€æœ¯ï¼Œå‘ç”Ÿ digital transformation æ˜¯å› ä¸ºæœ‰äº† Kubernetes ç­‰äº‘åŸç”ŸæŠ€æœ¯ï¼Œå…¶ä¸­çš„ä¸€äº›æ˜¾è‘—ç‰¹ç‚¹ï¼š

-   è½»é‡çº§çš„å®¹å™¨æŠ€æœ¯
-   ä¸ä¾èµ–åº•å±‚ infrastructure æˆ–æœåŠ¡ï¼ŒåŒ…æ‹¬ OSï¼ŒVMï¼Œç‰©ç†æœºå™¨ï¼Œä»¥åŠå„ç§äº‘åŸºç¡€è®¾æ–½
-   å£°æ˜å¼èµ„æºç®¡ç†
-   æŒ‰éœ€è‡ªåŠ¨å¼¹æ€§æ‰©å±•
-   æ‹¥æœ‰å¼ºå£®æ€§å’Œè‡ªæ„ˆåŠŸèƒ½
-   ç¼–ç¨‹è¯­è¨€æ— å…³
-   API é©±åŠ¨
-   Stateless/Stateful åº”ç”¨åˆ†ç¦»
-   å¾®æœåŠ¡æ¶æ„
-   æ•æ·å’Œè‡ªåŠ¨åŒ– DevOps
-   è‡ªæœåŠ¡

äº‘åŸç”Ÿä¼—è¯´çº·çº­ï¼Œæˆ‘çš„çœ‹æ³•å°±æ˜¯å®¹å™¨å’Œ Kubernetesï¼Œå› ä¸ºè¿˜æœªçœ‹åˆ°æœ‰ç¬¬äºŒç§æŠ€æœ¯æ¥å®ç°æ”¯æŒä¸Šè¿°ç‰¹æ€§ã€‚

---

<i class="fas fa-map-marker-alt"></i>&nbsp;&nbsp; Kubernetes ç›¸å½“ä¸€ä¸ªäº‘æ“ä½œç³»ç»Ÿå†…æ ¸ï¼Œå†…å¤–æ²¿æ¶‰åŠåˆ°çš„ä¸œè¥¿å‡ ä¹æ˜¯ä¸ªæ— åº•æ´ï¼Œä¸æ˜¯ 3-5 ä¸ªå°æ—¶æˆ– 3-5 å¤©å°±èƒ½æå®šï¼Œæ…¢æ…¢æ¥ã€‚

![kubernetes å†°å±±](/images/k8s/glacier.jpg#center)
